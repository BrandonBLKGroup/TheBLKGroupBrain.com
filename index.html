<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BLK Group Brain</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg: #0a0a0f;
  --surface: #12121a;
  --surface2: #1a1a28;
  --border: #2a2a3a;
  --text: #e0e0e8;
  --text-dim: #8888a0;
  --accent: #00d4ff;
  --accent-glow: rgba(0,212,255,0.15);
  --green: #00e676;
  --yellow: #ffd600;
  --orange: #ff9100;
  --red: #ff1744;
  --purple: #b388ff;
  --pink: #ff4081;
  --cyan: #00e5ff;
}

* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); overflow: hidden; height: 100vh; }

/* TOP BAR */
.topbar {
  height: 56px; background: var(--surface); border-bottom: 1px solid var(--border);
  display: flex; align-items: center; padding: 0 20px; gap: 16px; z-index: 100;
}
.topbar .logo { font-size: 20px; font-weight: 700; letter-spacing: 1px; }
.topbar .logo span { color: var(--accent); }
.topbar .market-select {
  background: var(--surface2); border: 1px solid var(--border); color: var(--text);
  padding: 6px 12px; border-radius: 6px; font-size: 14px; cursor: pointer;
}
.topbar .stats-bar {
  display: flex; gap: 20px; margin-left: auto; font-size: 13px;
}
.topbar .stat-item { display: flex; align-items: center; gap: 6px; }
.topbar .stat-item .dot { width: 8px; height: 8px; border-radius: 50%; }
.topbar .stat-item .val { font-weight: 600; color: var(--accent); }

/* LAYOUT */
.main-layout { display: flex; height: calc(100vh - 56px); }

/* SIDEBAR */
.sidebar {
  width: 320px; min-width: 320px; background: var(--surface);
  border-right: 1px solid var(--border); display: flex; flex-direction: column;
  overflow: hidden;
}
.sidebar-header {
  padding: 12px 16px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 8px;
}
.sidebar-header input {
  flex: 1; background: var(--surface2); border: 1px solid var(--border);
  color: var(--text); padding: 8px 12px; border-radius: 6px; font-size: 13px;
  outline: none;
}
.sidebar-header input:focus { border-color: var(--accent); }

/* FILTERS */
.filter-row {
  padding: 8px 16px; border-bottom: 1px solid var(--border);
  display: flex; flex-wrap: wrap; gap: 6px;
}
.filter-btn {
  padding: 4px 10px; border-radius: 12px; font-size: 11px; cursor: pointer;
  border: 1px solid var(--border); background: var(--surface2); color: var(--text-dim);
  transition: all 0.2s;
}
.filter-btn:hover, .filter-btn.active { border-color: var(--accent); color: var(--accent); background: var(--accent-glow); }

/* SUBDIVISION LIST */
.sub-list { flex: 1; overflow-y: auto; }
.sub-item {
  padding: 10px 16px; border-bottom: 1px solid rgba(42,42,58,0.5);
  cursor: pointer; transition: background 0.15s; display: flex; align-items: center; gap: 10px;
}
.sub-item:hover { background: var(--surface2); }
.sub-item.active { background: var(--accent-glow); border-left: 3px solid var(--accent); }
.sub-item .sub-name { font-size: 13px; font-weight: 500; flex: 1; }
.sub-item .sub-count { font-size: 12px; color: var(--text-dim); }
.sub-item .sub-stats { display: flex; gap: 4px; }
.sub-item .mini-dot { width: 6px; height: 6px; border-radius: 50%; }

/* MAP AREA */
.map-area { flex: 1; position: relative; }
#map { width: 100%; height: 100%; background: #0d0d15; }

/* RIGHT PANEL */
.right-panel {
  width: 380px; min-width: 380px; background: var(--surface);
  border-left: 1px solid var(--border); display: flex; flex-direction: column;
  overflow: hidden; transition: width 0.3s;
}
.right-panel.collapsed { width: 0; min-width: 0; }

.panel-header {
  padding: 12px 16px; border-bottom: 1px solid var(--border);
  font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px;
}
.panel-header .close-btn {
  margin-left: auto; cursor: pointer; color: var(--text-dim); font-size: 18px;
}

/* PARCEL DETAIL */
.parcel-detail { flex: 1; overflow-y: auto; padding: 16px; }
.detail-section { margin-bottom: 16px; }
.detail-section h4 { font-size: 12px; text-transform: uppercase; color: var(--text-dim); margin-bottom: 8px; letter-spacing: 1px; }
.detail-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 13px; }
.detail-row .label { color: var(--text-dim); }
.detail-row .value { font-weight: 500; text-align: right; max-width: 200px; word-break: break-word; }

/* STATUS BADGE */
.status-badge {
  display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 11px;
  font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
}
.status-unknown { background: rgba(136,136,160,0.2); color: var(--text-dim); }
.status-not_contacted { background: rgba(136,136,160,0.2); color: #aaa; }
.status-contacted { background: rgba(0,212,255,0.2); color: var(--accent); }
.status-mailed { background: rgba(179,136,255,0.2); color: var(--purple); }
.status-responded { background: rgba(255,214,0,0.2); color: var(--yellow); }
.status-off_market { background: rgba(0,230,118,0.2); color: var(--green); }
.status-considering { background: rgba(255,145,0,0.2); color: var(--orange); }
.status-listed_blk { background: rgba(255,23,68,0.2); color: var(--red); }
.status-listed_other { background: rgba(255,64,129,0.15); color: var(--pink); }
.status-sold_blk { background: rgba(0,229,255,0.2); color: var(--cyan); }
.status-sold_other { background: rgba(0,229,255,0.1); color: #66b2b2; }
.status-not_interested { background: rgba(100,100,100,0.2); color: #888; }
.status-do_not_contact { background: rgba(255,23,68,0.15); color: #ff5252; }

/* STATUS SELECTOR */
.status-select {
  background: var(--surface2); border: 1px solid var(--border); color: var(--text);
  padding: 6px 10px; border-radius: 6px; font-size: 12px; width: 100%; cursor: pointer;
}

/* NOTES */
.notes-area {
  width: 100%; background: var(--surface2); border: 1px solid var(--border);
  color: var(--text); padding: 8px 10px; border-radius: 6px; font-size: 12px;
  resize: vertical; min-height: 60px; font-family: inherit;
}
.notes-area:focus { border-color: var(--accent); outline: none; }

/* BUTTONS */
.btn {
  padding: 8px 16px; border-radius: 6px; font-size: 12px; font-weight: 600;
  cursor: pointer; border: none; transition: all 0.2s;
}
.btn-primary { background: var(--accent); color: #000; }
.btn-primary:hover { background: #33ddff; }
.btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
.btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
.btn-danger { background: rgba(255,23,68,0.2); color: var(--red); border: 1px solid rgba(255,23,68,0.3); }

/* ACTION BAR */
.action-bar {
  padding: 12px 16px; border-top: 1px solid var(--border);
  display: flex; gap: 8px; flex-wrap: wrap;
}

/* PARCEL LIST MODE */
.parcel-list-container { flex: 1; overflow-y: auto; }
.parcel-row {
  padding: 8px 16px; border-bottom: 1px solid rgba(42,42,58,0.3);
  cursor: pointer; transition: background 0.15s; font-size: 13px;
  display: flex; align-items: center; gap: 10px;
}
.parcel-row:hover { background: var(--surface2); }
.parcel-row .p-address { flex: 1; }
.parcel-row .p-owner { color: var(--text-dim); font-size: 12px; max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* TOAST */
.toast {
  position: fixed; bottom: 20px; right: 20px; background: var(--green); color: #000;
  padding: 12px 20px; border-radius: 8px; font-size: 13px; font-weight: 600;
  z-index: 1000; opacity: 0; transition: opacity 0.3s; pointer-events: none;
}
.toast.show { opacity: 1; }

/* LOADING */
.loading { text-align: center; padding: 40px; color: var(--text-dim); }
.loading .spinner {
  width: 30px; height: 30px; border: 3px solid var(--border);
  border-top-color: var(--accent); border-radius: 50%;
  animation: spin 0.8s linear infinite; margin: 0 auto 12px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* EXPORT MODAL */
.modal-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.7); z-index: 10000; display: none;
  align-items: center; justify-content: center;
}
.modal { z-index: 10001; }
.modal-overlay.show { display: flex; }
.modal {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 12px; padding: 24px; max-width: 500px; width: 90%;
}
.modal h3 { margin-bottom: 16px; }
.modal input {
  width: 100%; background: var(--surface2); border: 1px solid var(--border);
  color: var(--text); padding: 10px 12px; border-radius: 6px; font-size: 14px;
  margin-bottom: 12px;
}
.modal .btn-row { display: flex; gap: 8px; justify-content: flex-end; }

/* View toggle */
.view-toggle { display: flex; gap: 4px; }
.view-toggle .vt-btn {
  padding: 4px 10px; font-size: 11px; cursor: pointer;
  background: var(--surface2); border: 1px solid var(--border);
  color: var(--text-dim); border-radius: 4px;
}
.view-toggle .vt-btn.active { background: var(--accent-glow); color: var(--accent); border-color: var(--accent); }

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: #3a3a4a; }

/* Map parcel colors */
.leaflet-interactive { transition: fill-opacity 0.2s; }
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="logo"><span>BLK</span> GROUP BRAIN</div>
  <select class="market-select" id="marketSelect"></select>
  <div class="view-toggle">
    <button class="vt-btn active" id="btnMapView" onclick="setView('map')">Map</button>
    <button class="vt-btn" id="btnListView" onclick="setView('list')">List</button>
  </div>
  <div class="stats-bar" id="statsBar"></div>
</div>

<!-- MAIN LAYOUT -->
<div class="main-layout">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-header">
      <input type="text" id="searchInput" placeholder="Search address, owner, PIN...">
    </div>
    <div class="filter-row" id="filterRow">
      <button class="filter-btn active" data-filter="all">All</button>
      <button class="filter-btn" data-filter="not_contacted">Not Contacted</button>
      <button class="filter-btn" data-filter="contacted">Contacted</button>
      <button class="filter-btn" data-filter="mailed">Mailed</button>
      <button class="filter-btn" data-filter="responded">Responded</button>
      <button class="filter-btn" data-filter="off_market">Off-Market</button>
      <button class="filter-btn" data-filter="considering">Considering</button>
      <button class="filter-btn" data-filter="listed_blk">Listed (BLK)</button>
      <button class="filter-btn" data-filter="sold_blk">Sold (BLK)</button>
      <button class="filter-btn" data-filter="not_interested">Not Interested</button>
    </div>
    <div class="sub-list" id="subList">
      <div class="loading"><div class="spinner"></div>Loading subdivisions...</div>
    </div>
    <!-- Parcel list inside sidebar (shown when subdivision selected) -->
    <div class="sub-list" id="parcelSideList" style="display:none;"></div>
    <!-- Export button bar at bottom of sidebar -->
    <div id="sidebarActions" style="display:none; padding:10px 16px; border-top:1px solid var(--border); background:var(--surface);">
      <button class="btn btn-primary" style="width:100%;margin-bottom:6px;" onclick="openExportModal()">üìã Download for Wise Pelican</button>
      <button class="btn btn-secondary" style="width:100%;" onclick="markAllMailedPrompt()">üì¨ Mark All Mailed</button>
    </div>
  </div>

  <!-- MAP -->
  <div class="map-area" id="mapArea">
    <div id="map"></div>
  </div>

  <!-- PARCEL LIST (hidden by default) -->
  <div class="parcel-list-container" id="parcelListArea" style="display:none; flex:1; background:var(--bg);">
    <table style="width:100%; border-collapse:collapse;">
      <thead style="position:sticky;top:0;background:var(--surface);z-index:10;">
        <tr style="font-size:12px;text-transform:uppercase;color:var(--text-dim);letter-spacing:0.5px;">
          <th style="padding:10px 16px;text-align:left;">Address</th>
          <th style="padding:10px 16px;text-align:left;">Owner</th>
          <th style="padding:10px 16px;text-align:left;">Subdivision</th>
          <th style="padding:10px 16px;text-align:left;">Status</th>
          <th style="padding:10px 16px;text-align:left;">PIN</th>
        </tr>
      </thead>
      <tbody id="parcelTableBody"></tbody>
    </table>
  </div>

  <!-- RIGHT PANEL -->
  <div class="right-panel collapsed" id="rightPanel">
    <div class="panel-header">
      <span id="panelTitle">Parcel Details</span>
      <span class="close-btn" onclick="closePanel()">&times;</span>
    </div>
    <div class="parcel-detail" id="parcelDetail"></div>
    <div class="action-bar" id="actionBar"></div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- EXPORT MODAL -->
<div class="modal-overlay" id="exportModal">
  <div class="modal">
    <h3>Export Mailing List</h3>
    <p style="font-size:13px;color:var(--text-dim);margin-bottom:12px;">Download a Wise Pelican-ready CSV for the selected subdivision.</p>
    <input type="text" id="exportCampaign" placeholder="Campaign name (e.g., Q1-2026-Chenal)">
    <label style="font-size:12px;color:var(--text-dim);display:flex;align-items:center;gap:6px;margin-bottom:16px;">
      <input type="checkbox" id="exportMarkMailed"> Mark all parcels as mailed
    </label>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="closeExportModal()">Cancel</button>
      <button class="btn btn-primary" onclick="doExport()">Download CSV</button>
    </div>
  </div>
</div>

<script>
// ============================================
// SUPABASE CONNECTION
// ============================================
const SUPABASE_URL = 'https://fzlwkbhpsklsgkinwljt.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ6bHdrYmhwc2tsc2draW53bGp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNTE0MzEsImV4cCI6MjA4NzYyNzQzMX0.lc6A8RCUySU0Hn9MjPcR9rH1c8DjSj_A7MV8JuLvwik';
const SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ6bHdrYmhwc2tsc2draW53bGp0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MjA1MTQzMSwiZXhwIjoyMDg3NjI3NDMxfQ.PKPShz05ibsEXYKksSNcTeyR0tjB_z1YEk3oOLMyVIc';

const sb = supabase.createClient(SUPABASE_URL, SERVICE_KEY);

// ============================================
// STATE
// ============================================
let allMarkets = [];
let currentMarketId = null;
let allSubdivisions = [];
let allParcels = [];
let selectedSubId = null;
let selectedParcelId = null;
let currentFilter = 'all';
let searchTerm = '';
let currentView = 'map';
let map, parcelLayers = {}, subLayers = {};

const STATUS_COLORS = {
  unknown: '#555566',
  not_contacted: '#666680',
  contacted: '#00d4ff',
  mailed: '#b388ff',
  responded: '#ffd600',
  off_market: '#00e676',
  considering: '#ff9100',
  listed_blk: '#ff1744',
  listed_other: '#ff4081',
  sold_blk: '#00e5ff',
  sold_other: '#4db6ac',
  not_interested: '#616161',
  do_not_contact: '#d32f2f',
};

// ============================================
// INIT
// ============================================
async function init() {
  await loadMarkets();
  initMap();
  initSearch();
  initFilters();
  if (allMarkets.length > 0) {
    const active = allMarkets.find(m => m.is_active) || allMarkets[0];
    currentMarketId = active.id;
    document.getElementById('marketSelect').value = currentMarketId;
    await loadMarketData();
  }
}

async function loadMarkets() {
  const { data } = await sb.from('markets').select('*').order('name');
  allMarkets = data || [];
  const sel = document.getElementById('marketSelect');
  sel.innerHTML = allMarkets.map(m =>
    `<option value="${m.id}">${m.display_name}${m.is_active ? ' (Active)' : ''}</option>`
  ).join('');
  sel.onchange = async () => {
    currentMarketId = sel.value;
    selectedSubId = null;
    selectedParcelId = null;
    closePanel();
    await loadMarketData();
  };
}

function initMap() {
  map = L.map('map', {
    center: [34.75, -92.45],
    zoom: 12,
    zoomControl: true,
    preferCanvas: true,
  });
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    maxZoom: 19,
    attribution: '&copy; CARTO'
  }).addTo(map);
}

function initSearch() {
  const input = document.getElementById('searchInput');
  let timer;
  input.oninput = () => {
    clearTimeout(timer);
    timer = setTimeout(() => {
      searchTerm = input.value.toLowerCase().trim();
      renderSubList();
      renderMap();
    }, 250);
  };
}

function initFilters() {
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentFilter = btn.dataset.filter;
      renderSubList();
      renderMap();
    };
  });
}

// ============================================
// DATA LOADING
// ============================================
async function loadMarketData() {
  document.getElementById('subList').innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';

  // Load subdivisions
  const { data: subs } = await sb.from('subdivisions')
    .select('*')
    .eq('market_id', currentMarketId)
    .order('name');
  allSubdivisions = subs || [];

  // Load parcels (paginated - Supabase returns max 1000)
  allParcels = [];
  let from = 0;
  const pageSize = 1000;
  while (true) {
    const { data: batch } = await sb.from('parcels')
      .select('id,pin,address,city,zip,owner_full_name,owner_first_name,owner_last_name,subdivision_id,status,off_market_willing,notes,phone,email,skiptraced,last_mailed_at,times_mailed,center_lat,center_lng,parcel_geojson,mail_history,tags')
      .eq('market_id', currentMarketId)
      .range(from, from + pageSize - 1);
    if (!batch || batch.length === 0) break;
    allParcels.push(...batch);
    if (batch.length < pageSize) break;
    from += pageSize;
  }

  updateStats();
  renderSubList();
  renderMap();
}

// ============================================
// STATS BAR
// ============================================
function updateStats() {
  const total = allParcels.length;
  const counts = {};
  allParcels.forEach(p => { counts[p.status] = (counts[p.status] || 0) + 1; });

  const statsHtml = [
    { label: 'Total', val: total, color: '#fff' },
    { label: 'Off-Market', val: counts.off_market || 0, color: STATUS_COLORS.off_market },
    { label: 'Contacted', val: counts.contacted || 0, color: STATUS_COLORS.contacted },
    { label: 'Mailed', val: counts.mailed || 0, color: STATUS_COLORS.mailed },
    { label: 'Responded', val: counts.responded || 0, color: STATUS_COLORS.responded },
    { label: 'Listed', val: counts.listed_blk || 0, color: STATUS_COLORS.listed_blk },
    { label: 'Sold', val: counts.sold_blk || 0, color: STATUS_COLORS.sold_blk },
  ].map(s => `
    <div class="stat-item">
      <div class="dot" style="background:${s.color}"></div>
      <span>${s.label}:</span>
      <span class="val">${s.val.toLocaleString()}</span>
    </div>
  `).join('');

  document.getElementById('statsBar').innerHTML = statsHtml;
}

// ============================================
// SUBDIVISION LIST
// ============================================
function renderSubList() {
  const container = document.getElementById('subList');

  // Calculate per-subdivision stats
  const subStats = {};
  const filteredParcels = getFilteredParcels();

  filteredParcels.forEach(p => {
    const sid = p.subdivision_id || 'none';
    if (!subStats[sid]) subStats[sid] = { count: 0, statuses: {} };
    subStats[sid].count++;
    subStats[sid].statuses[p.status] = (subStats[sid].statuses[p.status] || 0) + 1;
  });

  // "All Parcels" item
  let html = `
    <div class="sub-item ${!selectedSubId ? 'active' : ''}" onclick="selectSub(null)">
      <div class="sub-name">All Parcels</div>
      <div class="sub-count">${filteredParcels.length}</div>
    </div>
  `;

  // Sort subdivisions by parcel count
  const sorted = [...allSubdivisions].sort((a, b) => {
    const ca = subStats[a.id]?.count || 0;
    const cb = subStats[b.id]?.count || 0;
    return cb - ca;
  });

  for (const sub of sorted) {
    const stats = subStats[sub.id];
    if (!stats || stats.count === 0) continue;

    const statusDots = Object.entries(stats.statuses)
      .filter(([s]) => s !== 'not_contacted' && s !== 'unknown')
      .slice(0, 4)
      .map(([s]) => `<div class="mini-dot" style="background:${STATUS_COLORS[s]}"></div>`)
      .join('');

    html += `
      <div class="sub-item ${selectedSubId === sub.id ? 'active' : ''}" onclick="selectSub('${sub.id}')">
        <div class="sub-name">${sub.display_name || sub.name}</div>
        <div class="sub-stats">${statusDots}</div>
        <div class="sub-count">${stats.count}</div>
      </div>
    `;
  }

  container.innerHTML = html;
}

function selectSub(subId) {
  selectedSubId = subId;
  selectedParcelId = null;
  renderSubList();
  renderMap();
  if (currentView === 'list') renderParcelTable();
  closePanel();

  if (subId) {
    // Show parcel list in sidebar
    renderParcelSideList();
    document.getElementById('subList').style.display = 'none';
    document.getElementById('parcelSideList').style.display = '';
    document.getElementById('sidebarActions').style.display = '';

    // Zoom to subdivision
    const sub = allSubdivisions.find(s => s.id === subId);
    if (sub && sub.center_lat && sub.center_lng) {
      map.setView([sub.center_lat, sub.center_lng], 16);
    }
  } else {
    // Back to subdivision list
    document.getElementById('subList').style.display = '';
    document.getElementById('parcelSideList').style.display = 'none';
    document.getElementById('sidebarActions').style.display = 'none';
  }
}

function renderParcelSideList() {
  const container = document.getElementById('parcelSideList');
  const filtered = getFilteredParcels();
  const sub = allSubdivisions.find(s => s.id === selectedSubId);
  const subName = sub ? (sub.display_name || sub.name) : 'Parcels';

  let html = `
    <div class="sub-item" onclick="selectSub(null)" style="background:var(--surface2);border-bottom:2px solid var(--accent);">
      <div class="sub-name" style="color:var(--accent);">‚Üê Back to Subdivisions</div>
    </div>
    <div style="padding:10px 16px;border-bottom:1px solid var(--border);font-size:14px;font-weight:600;">
      ${subName} <span style="color:var(--text-dim);font-weight:400;font-size:12px;">(${filtered.length} parcels)</span>
    </div>
  `;

  for (const p of filtered) {
    const color = STATUS_COLORS[p.status] || STATUS_COLORS.unknown;
    html += `
      <div class="sub-item ${selectedParcelId === p.id ? 'active' : ''}" onclick="selectParcel('${p.id}')">
        <div class="mini-dot" style="background:${color};width:8px;height:8px;"></div>
        <div style="flex:1;overflow:hidden;">
          <div class="sub-name" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${p.address || 'No address'}</div>
          <div style="font-size:11px;color:var(--text-dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${p.owner_full_name || 'Unknown owner'}</div>
        </div>
        <span class="status-badge status-${p.status}" style="font-size:9px;padding:2px 6px;">${p.status.replace(/_/g, ' ')}</span>
      </div>
    `;
  }

  container.innerHTML = html;
}

function markAllMailedPrompt() {
  const campaign = prompt('Campaign name (e.g., Q1-2026-Chenal):');
  if (!campaign) return;
  markAllMailed(campaign);
}

async function markAllMailed(campaign) {
  const filtered = getFilteredParcels();
  const now = new Date().toISOString();
  const ids = filtered.map(p => p.id);

  for (let i = 0; i < ids.length; i += 100) {
    const batch = ids.slice(i, i + 100);
    await sb.from('parcels').update({
      status: 'mailed',
      last_mailed_at: now,
    }).in('id', batch);
  }

  // Update local state
  filtered.forEach(p => {
    p.status = 'mailed';
    p.last_mailed_at = now;
    p.times_mailed = (p.times_mailed || 0) + 1;
  });

  updateStats();
  renderSubList();
  renderParcelSideList();
  renderMap();
  showToast(`Marked ${filtered.length} parcels as mailed (${campaign})`);
}

// ============================================
// FILTERING
// ============================================
function getFilteredParcels() {
  return allParcels.filter(p => {
    if (currentFilter !== 'all' && p.status !== currentFilter) return false;
    if (selectedSubId && p.subdivision_id !== selectedSubId) return false;
    if (searchTerm) {
      const hay = `${p.address} ${p.owner_full_name} ${p.pin} ${p.phone} ${p.email}`.toLowerCase();
      if (!hay.includes(searchTerm)) return false;
    }
    return true;
  });
}

// ============================================
// MAP RENDERING
// ============================================
function renderMap() {
  // Clear existing layers
  Object.values(parcelLayers).forEach(l => map.removeLayer(l));
  Object.values(subLayers).forEach(l => map.removeLayer(l));
  parcelLayers = {};
  subLayers = {};

  const filtered = getFilteredParcels();
  const bounds = [];

  // Draw subdivision boundaries
  if (!selectedSubId) {
    allSubdivisions.forEach(sub => {
      if (!sub.boundary_geojson) return;
      try {
        const layer = L.geoJSON(sub.boundary_geojson, {
          style: { color: '#334', weight: 1, fillOpacity: 0.05, fillColor: '#00d4ff' }
        }).addTo(map);
        layer.on('click', () => selectSub(sub.id));
        layer.bindTooltip(sub.display_name || sub.name, { sticky: true, className: 'sub-tooltip' });
        subLayers[sub.id] = layer;
      } catch(e) {}
    });
  }

  // Draw parcels
  for (const p of filtered) {
    if (!p.center_lat || !p.center_lng) continue;
    const color = STATUS_COLORS[p.status] || STATUS_COLORS.unknown;
    const radius = selectedSubId ? 8 : 4;
    const circle = L.circleMarker([p.center_lat, p.center_lng], {
      radius: radius,
      fillColor: color,
      fillOpacity: 0.7,
      color: color,
      weight: 1,
      opacity: 0.9,
    }).addTo(map);

    circle.on('click', () => selectParcel(p.id));
    circle.bindTooltip(`${p.address || 'No address'}<br>${p.owner_full_name || ''}`, { className: 'parcel-tooltip' });
    parcelLayers[p.id] = circle;
    bounds.push([p.center_lat, p.center_lng]);
  }

  // Fit bounds
  if (bounds.length > 0 && !selectedSubId) {
    map.fitBounds(bounds, { padding: [20, 20] });
  }
}

// ============================================
// PARCEL TABLE (List View)
// ============================================
function renderParcelTable() {
  const filtered = getFilteredParcels();
  const tbody = document.getElementById('parcelTableBody');
  const subMap = {};
  allSubdivisions.forEach(s => { subMap[s.id] = s.display_name || s.name; });

  tbody.innerHTML = filtered.map(p => `
    <tr class="parcel-row" onclick="selectParcel('${p.id}')">
      <td style="padding:8px 16px;">${p.address || 'N/A'}</td>
      <td style="padding:8px 16px;color:var(--text-dim);font-size:12px;">${p.owner_full_name || 'N/A'}</td>
      <td style="padding:8px 16px;color:var(--text-dim);font-size:12px;">${subMap[p.subdivision_id] || 'N/A'}</td>
      <td style="padding:8px 16px;"><span class="status-badge status-${p.status}">${p.status.replace(/_/g, ' ')}</span></td>
      <td style="padding:8px 16px;color:var(--text-dim);font-size:11px;">${p.pin || ''}</td>
    </tr>
  `).join('');
}

// ============================================
// VIEW TOGGLE
// ============================================
function setView(view) {
  currentView = view;
  document.getElementById('btnMapView').classList.toggle('active', view === 'map');
  document.getElementById('btnListView').classList.toggle('active', view === 'list');
  document.getElementById('mapArea').style.display = view === 'map' ? '' : 'none';
  document.getElementById('parcelListArea').style.display = view === 'list' ? '' : 'none';
  if (view === 'list') renderParcelTable();
  if (view === 'map') setTimeout(() => map.invalidateSize(), 100);
}

// ============================================
// PARCEL SELECTION & DETAIL PANEL
// ============================================
async function selectParcel(parcelId) {
  selectedParcelId = parcelId;
  const p = allParcels.find(x => x.id === parcelId);
  if (!p) return;

  // Update sidebar highlight if in subdivision view
  if (selectedSubId) renderParcelSideList();

  const panel = document.getElementById('rightPanel');
  panel.classList.remove('collapsed');
  setTimeout(() => map.invalidateSize(), 350);

  const sub = allSubdivisions.find(s => s.id === p.subdivision_id);
  document.getElementById('panelTitle').textContent = p.address || 'Parcel Details';

  const detail = document.getElementById('parcelDetail');
  detail.innerHTML = `
    <div class="detail-section">
      <h4>Property</h4>
      <div class="detail-row"><span class="label">Address</span><span class="value">${p.address || 'N/A'}</span></div>
      <div class="detail-row"><span class="label">City/State/Zip</span><span class="value">${p.city || ''}, AR ${p.zip || ''}</span></div>
      <div class="detail-row"><span class="label">PIN</span><span class="value">${p.pin || 'N/A'}</span></div>
      <div class="detail-row"><span class="label">Subdivision</span><span class="value">${sub ? (sub.display_name || sub.name) : 'N/A'}</span></div>
    </div>

    <div class="detail-section">
      <h4>Owner</h4>
      <div class="detail-row"><span class="label">Name</span><span class="value">${p.owner_full_name || 'N/A'}</span></div>
      <div class="detail-row"><span class="label">Phone</span><span class="value">${p.phone || '<span style="color:var(--text-dim)">Not skiptraced</span>'}</span></div>
      <div class="detail-row"><span class="label">Email</span><span class="value">${p.email || '<span style="color:var(--text-dim)">None</span>'}</span></div>
      <div class="detail-row"><span class="label">Skiptraced</span><span class="value">${p.skiptraced ? '<span style="color:var(--green)">Yes</span>' : '<span style="color:var(--text-dim)">No</span>'}</span></div>
    </div>

    <div class="detail-section">
      <h4>Status</h4>
      <select class="status-select" id="statusSelect" onchange="updateParcelStatus('${p.id}', this.value)">
        ${Object.keys(STATUS_COLORS).map(s =>
          `<option value="${s}" ${p.status === s ? 'selected' : ''}>${s.replace(/_/g, ' ').toUpperCase()}</option>`
        ).join('')}
      </select>
      <div style="margin-top:8px;">
        <label style="font-size:12px;display:flex;align-items:center;gap:6px;color:var(--text-dim);">
          <input type="checkbox" id="offMarketCheck" ${p.off_market_willing ? 'checked' : ''}
            onchange="updateParcelField('${p.id}', 'off_market_willing', this.checked)">
          Willing to sell off-market
        </label>
      </div>
    </div>

    <div class="detail-section">
      <h4>Mailing</h4>
      <div class="detail-row"><span class="label">Times Mailed</span><span class="value">${p.times_mailed || 0}</span></div>
      <div class="detail-row"><span class="label">Last Mailed</span><span class="value">${p.last_mailed_at ? new Date(p.last_mailed_at).toLocaleDateString() : 'Never'}</span></div>
    </div>

    <div class="detail-section">
      <h4>Notes</h4>
      <textarea class="notes-area" id="notesArea" placeholder="Add notes...">${p.notes || ''}</textarea>
      <button class="btn btn-secondary" style="margin-top:6px;width:100%;" onclick="saveNotes('${p.id}')">Save Notes</button>
    </div>

    <div class="detail-section">
      <h4>Contact</h4>
      <div style="display:flex;gap:8px;margin-bottom:6px;">
        <input type="text" id="phoneInput" value="${p.phone || ''}" placeholder="Phone" style="flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:6px;font-size:12px;">
        <input type="text" id="emailInput" value="${p.email || ''}" placeholder="Email" style="flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:6px;font-size:12px;">
      </div>
      <button class="btn btn-secondary" style="width:100%;" onclick="saveContact('${p.id}')">Save Contact Info</button>
    </div>
  `;

  // Highlight on map
  Object.values(parcelLayers).forEach(l => { l.setStyle({ weight: 1 }); });
  if (parcelLayers[parcelId]) {
    parcelLayers[parcelId].setStyle({ weight: 3, color: '#fff' });
    const ll = parcelLayers[parcelId].getLatLng();
    map.panTo(ll);
  }

  // Action bar
  document.getElementById('actionBar').innerHTML = `
    <button class="btn btn-secondary" onclick="openExportModal()">Export Mailing CSV</button>
    <button class="btn btn-danger" onclick="updateParcelStatus('${p.id}', 'do_not_contact')">DNC</button>
  `;
}

function closePanel() {
  document.getElementById('rightPanel').classList.add('collapsed');
  selectedParcelId = null;
  Object.values(parcelLayers).forEach(l => { l.setStyle({ weight: 1 }); });
  setTimeout(() => map.invalidateSize(), 350);
}

// ============================================
// DATA UPDATES
// ============================================
async function updateParcelStatus(id, status) {
  const { error } = await sb.from('parcels').update({ status }).eq('id', id);
  if (error) { showToast('Error: ' + error.message, true); return; }
  const p = allParcels.find(x => x.id === id);
  if (p) p.status = status;
  updateStats();
  renderSubList();
  if (parcelLayers[id]) {
    parcelLayers[id].setStyle({ fillColor: STATUS_COLORS[status], color: STATUS_COLORS[status] });
  }
  showToast('Status updated');
}

async function updateParcelField(id, field, value) {
  const { error } = await sb.from('parcels').update({ [field]: value }).eq('id', id);
  if (error) { showToast('Error: ' + error.message, true); return; }
  const p = allParcels.find(x => x.id === id);
  if (p) p[field] = value;
  showToast('Updated');
}

async function saveNotes(id) {
  const notes = document.getElementById('notesArea').value;
  await updateParcelField(id, 'notes', notes);
}

async function saveContact(id) {
  const phone = document.getElementById('phoneInput').value;
  const email = document.getElementById('emailInput').value;
  const { error } = await sb.from('parcels').update({ phone, email, skiptraced: !!phone }).eq('id', id);
  if (error) { showToast('Error: ' + error.message, true); return; }
  const p = allParcels.find(x => x.id === id);
  if (p) { p.phone = phone; p.email = email; p.skiptraced = !!phone; }
  showToast('Contact info saved');
}

// ============================================
// EXPORT
// ============================================
function openExportModal() {
  document.getElementById('exportModal').classList.add('show');
}
function closeExportModal() {
  document.getElementById('exportModal').classList.remove('show');
}

function doExport() {
  const campaign = document.getElementById('exportCampaign').value || 'export';
  const markMailed = document.getElementById('exportMarkMailed').checked;
  const parcels = getFilteredParcels();

  if (parcels.length === 0) {
    showToast('No parcels to export', true);
    closeExportModal();
    return;
  }

  // Build CSV
  const rows = [['First Name', 'Last Name', 'Address', 'City', 'State', 'Zip']];
  for (const p of parcels) {
    rows.push([
      (p.owner_first_name || '').replace(/"/g, '""'),
      (p.owner_last_name || '').replace(/"/g, '""'),
      (p.address || '').replace(/"/g, '""'),
      (p.city || 'Little Rock').replace(/"/g, '""'),
      'AR',
      (p.zip || '').replace(/"/g, '""')
    ]);
  }
  const csv = rows.map(r => r.map(c => `"${c}"`).join(',')).join('\r\n');

  // Download using data URI (more compatible than blob)
  const encodedCsv = encodeURIComponent(csv);
  const a = document.createElement('a');
  a.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodedCsv);
  a.setAttribute('download', `${campaign}-wise-pelican.csv`);
  a.style.display = 'none';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);

  // Mark as mailed if checked
  if (markMailed) {
    doMarkMailed(parcels, campaign);
  } else {
    showToast(`Exported ${parcels.length} parcels`);
  }

  closeExportModal();
}

async function doMarkMailed(parcels, campaign) {
  const now = new Date().toISOString();
  const ids = parcels.map(p => p.id);
  for (let i = 0; i < ids.length; i += 100) {
    const batch = ids.slice(i, i + 100);
    await sb.from('parcels').update({
      status: 'mailed',
      last_mailed_at: now,
    }).in('id', batch);
  }
  parcels.forEach(p => {
    p.status = 'mailed';
    p.last_mailed_at = now;
    p.times_mailed = (p.times_mailed || 0) + 1;
  });
  updateStats();
  renderSubList();
  if (selectedSubId) renderParcelSideList();
  renderMap();
  showToast(`Exported & marked ${parcels.length} parcels as mailed (${campaign})`);
}

// ============================================
// TOAST
// ============================================
function showToast(msg, isError) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.style.background = isError ? 'var(--red)' : 'var(--green)';
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2500);
}

// ============================================
// BOOT
// ============================================
init();
</script>
</body>
</html>